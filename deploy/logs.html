

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Logging and monitoring &mdash; Cornflow 0.4 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Supported clients" href="../clients/index.html" />
    <link rel="prev" title="Access control" href="access.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Cornflow
          

          
          </a>

          
            
            
              <div class="version">
                0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../main/index.html">Main topics</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Deployment</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Before you begin</a></li>
<li class="toctree-l2"><a class="reference internal" href="docker-compose.yml.html">docker-compose.yml</a></li>
<li class="toctree-l2"><a class="reference internal" href="docker-stack.html">Docker stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="simultaneous.html">Running with simultaneous resolutions</a></li>
<li class="toctree-l2"><a class="reference internal" href="options.html">Deployment options</a></li>
<li class="toctree-l2"><a class="reference internal" href="production.html">Production deployment and security</a></li>
<li class="toctree-l2"><a class="reference internal" href="access.html">Access control</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Logging and monitoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cornflow-logs">Cornflow logs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#airflow-logs">Airflow logs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#scheduler-log">Scheduler log</a></li>
<li class="toctree-l4"><a class="reference internal" href="#worker-logs">Worker logs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#monitoring">Monitoring</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cornflow-monitoring">Cornflow monitoring</a></li>
<li class="toctree-l4"><a class="reference internal" href="#airflow-monitoring">Airflow monitoring</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../clients/index.html">Supported clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guides/index.html">Guides and how-to</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/index.html">Code documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stable-rest-api-ref.html">API reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Cornflow</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Deployment</a> &raquo;</li>
        
      <li>Logging and monitoring</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/deploy/logs.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="logging-and-monitoring">
<h1>Logging and monitoring<a class="headerlink" href="#logging-and-monitoring" title="Permalink to this headline">¶</a></h1>
<div class="section" id="cornflow-logs">
<h2>Cornflow logs<a class="headerlink" href="#cornflow-logs" title="Permalink to this headline">¶</a></h2>
<p>Cornflow logs are written to console output (stdout) by default. In this way you can visualize them by launching the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>docker logs `docker ps -q --filter ancestor=baobabsoluciones/cornflow`
</pre></div>
</div>
<p>If you want to know about the possibilities offered by the docker log engine, you can visit the official documentation <a class="reference external" href="https://docs.docker.com/engine/reference/commandline/logs/">here</a>.</p>
<p>If you want to activate the persistent log storage in files, you must pass the value <code class="docutils literal notranslate"><span class="pre">file</span></code> to the environment variable <code class="docutils literal notranslate"><span class="pre">CORNFLOW_LOGGING</span></code> in the cornflow server deployment.
Once the log storage is activated, these will be saved in the path <code class="docutils literal notranslate"><span class="pre">/usr/src/app/log</span></code> inside the cornflow container.
To permanently store the logs even if the service is destroyed, you can mount a volume against the directory as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">volume</span> <span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to_storage</span><span class="o">/</span><span class="n">cornflow</span><span class="o">/</span><span class="n">logs</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">log</span>
</pre></div>
</div>
<p>The log files will rotate and be compressed following the configuration provided to the logrotate service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">number</span> <span class="n">of</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">directory</span> <span class="o">-</span> <span class="mi">30</span>
<span class="n">frequency</span> <span class="o">-</span> <span class="n">daily</span>
<span class="n">log</span> <span class="n">file</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">20</span><span class="n">M</span>
</pre></div>
</div>
<p>Two files will be created in log directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>info.log - record messages with access to the application with the default log level value ``info``
error.log - here the application errors will be recorded
</pre></div>
</div>
<p>The compressed logs will have this format: <code class="docutils literal notranslate"><span class="pre">info.log.1.gz</span></code></p>
</div>
<div class="section" id="airflow-logs">
<h2>Airflow logs<a class="headerlink" href="#airflow-logs" title="Permalink to this headline">¶</a></h2>
<p>Airflow supports a variety of logging and monitoring mechanisms as shown on it’s <a class="reference external" href="https://airflow.apache.org/docs/apache-airflow/stable/logging-monitoring/index.html#logging-monitoring">documentation page</a>.</p>
<div class="section" id="scheduler-log">
<h3>Scheduler log<a class="headerlink" href="#scheduler-log" title="Permalink to this headline">¶</a></h3>
<p>The logs are stored in the logs folder within the <code class="docutils literal notranslate"><span class="pre">$AIRFLOW_HOME</span></code> directory.</p>
<p>The scheduler logs are named after the DAGs handled by the service. Navigate to where the log file is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>docker exec -it `docker ps -q --filter name=scheduler` bash -c &quot;ls -l ${AIRFLOW_HOME}logs/scheduler/latest/&quot;

-rw-r--r-- 1 airflow airflow 1377544 May 20 10:04 dag_timer.py.log
-rw-r--r-- 1 airflow airflow 1168103 May 20 10:03 graph_coloring.py.log
-rw-r--r-- 1 airflow airflow 1454702 May 20 10:04 hk_2020_dag.py.log
-rw-r--r-- 1 airflow airflow 1370681 May 20 10:03 optim_dag.py.log
-rw-r--r-- 1 airflow airflow 1495255 May 20 10:03 update_all_schemas.py.log
</pre></div>
</div>
</div>
<div class="section" id="worker-logs">
<h3>Worker logs<a class="headerlink" href="#worker-logs" title="Permalink to this headline">¶</a></h3>
<p>As in the rest of airflow services, the logs are stored in the logs folder within the <a href="#id1"><span class="problematic" id="id2">``</span></a>$AIRFLOW_HOME``directory.
The logs are divided into folders with the name of the DAGs and into subfolders with their execution dates.</p>
<p>If we want to view logs with a command, here things get a bit complicated since we can have different workers deployed, with different DAGs. We must help ourselves with the linux bash commands to filter the search as much as possible. Let’s say we want to review today logs of the DAG <code class="docutils literal notranslate"><span class="pre">update_all_squemas</span></code> in every worker:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for id in `docker ps -q --filter name=worker_`; do docker exec -it $id bash -c &quot;tail ${AIRFLOW_HOME}logs/update_all_schemas/update_all_schemas/$(date +%Y-%m-%d)*/*.log&quot;;done;

[2021-05-19 17:37:27,173] {logging_mixin.py:104} INFO - looking for apps in dir=/usr/local/airflow/dags
[2021-05-19 17:37:27,173] {logging_mixin.py:104} INFO - Files are: [&#39;graph_coloring.py&#39;, &#39;update_all_schemas.py&#39;, &#39;__init__.py&#39;, &#39;graph_coloring_output.json&#39;, &#39;hk_2020_dag.py&#39;, &#39;dag_timer.py&#39;, &#39;graph_coloring_input.json&#39;, &#39;__pycache__&#39;, &#39;optim_dag.py&#39;]
[2021-05-19 17:37:28,149] {logging_mixin.py:104} WARNING - /usr/local/airflow/.local/lib/python3.8/site-packages/hackathonbaobab2020/execution/__init__.py:7 UserWarning: To use the benchmark functions, you need to install the benchmark dependencies:
`pip install hackathonbaobab2020[benchmark]`
[2021-05-19 17:37:28,251] {logging_mixin.py:104} INFO - Found the following apps: [&#39;graph_coloring&#39;, &#39;hk_2020_dag&#39;, &#39;timer&#39;, &#39;solve_model_dag&#39;]
[2021-05-19 17:37:28,571] {python.py:118} INFO - Done. Returned value was: None
[2021-05-19 17:37:28,588] {taskinstance.py:1185} INFO - Marking task as SUCCESS. dag_id=update_all_schemas, task_id=update_all_schemas, execution_date=20210518T173709, start_date=20210519T173726, end_date=20210519T173728
[2021-05-19 17:37:28,629] {taskinstance.py:1246} INFO - 0 downstream tasks scheduled from follow-on schedule check
[2021-05-19 17:37:28,654] {local_task_job.py:146} INFO - Task exited with return code 0
&#39;logs/update_all_schemas/update_all_schemas/2021-05-18*/*.log&#39;: No such file or directory
</pre></div>
</div>
<p>Note that we can get an error of the type (<code class="docutils literal notranslate"><span class="pre">No</span> <span class="pre">such</span> <span class="pre">file</span> <span class="pre">or</span> <span class="pre">directory</span></code>) because that log does not exist in all workers.</p>
</div>
</div>
<div class="section" id="monitoring">
<h2>Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this headline">¶</a></h2>
<div class="section" id="cornflow-monitoring">
<h3>Cornflow monitoring<a class="headerlink" href="#cornflow-monitoring" title="Permalink to this headline">¶</a></h3>
<p>You can call the <code class="docutils literal notranslate"><span class="pre">/health</span></code> endpoint to obtain the status of the cornflow and airflow servers. It should return a 200 code as well as “healthy” of status for both <code class="docutils literal notranslate"><span class="pre">cornflow_status</span></code> and <code class="docutils literal notranslate"><span class="pre">airflow_status</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;airflow_status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span>
  <span class="s2">&quot;cornflow_status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Check the <a class="reference external" href="https://baobabsoluciones.github.io/corn/stable-rest-api-ref.html#tag/Health">API docs</a> for more information.</p>
</div>
<div class="section" id="airflow-monitoring">
<h3>Airflow monitoring<a class="headerlink" href="#airflow-monitoring" title="Permalink to this headline">¶</a></h3>
<p>To check the <a class="reference external" href="https://airflow.apache.org/docs/apache-airflow/stable/logging-monitoring/check-health.html#checking-airflow-health-status">health status of your Airflow instance</a> directly without using cornflow, you can simply access the endpoint <code class="docutils literal notranslate"><span class="pre">/health</span></code>. It will return a JSON object in which a high-level glance is provided.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../clients/index.html" class="btn btn-neutral float-right" title="Supported clients" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="access.html" class="btn btn-neutral float-left" title="Access control" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020-, cornflow documentation team..

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>